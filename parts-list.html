<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Parts Catalog</title>
  <style>
    :root {
      --bg: #f7f8fa;
      --card-bg: #ffffff;
      --text: #0f172a;
      --muted: #64748b;
      --accent: #2563eb;
      --border: #e5e7eb;
      --shadow: 0 10px 20px rgba(2, 8, 23, 0.06);
      --radius: 14px;
      --maxw: 1200px;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      color: var(--text);
      background: linear-gradient(180deg, #f8fafc, #eef2f7);
    }

    .container {
      max-width: var(--maxw);
      margin: 0 auto;
      padding: 24px 16px 48px;
    }

    header {
      display: grid;
      gap: 10px;
      margin-bottom: 16px;
    }
    .title {
      font-size: clamp(22px, 4vw, 34px);
      font-weight: 800;
      letter-spacing: -0.02em;
    }
    .subtitle {
      color: var(--muted);
      font-size: 15px;
    }

    .toolbar {
      position: sticky;
      top: 0;
      z-index: 10;
      padding: 12px 0 20px;
      background: linear-gradient(180deg, rgba(248,250,252,0.85), rgba(248,250,252,0));
      backdrop-filter: blur(6px);
    }

    .search-wrap {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items: center;
    }

    .search {
      display: flex;
      align-items: center;
      gap: 10px;
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 12px;
      box-shadow: var(--shadow);
    }
    .search input {
      width: 100%;
      border: none;
      outline: none;
      background: transparent;
      font-size: 16px;
      color: var(--text);
    }
    .search .icon {
      width: 22px;
      height: 22px;
      color: var(--muted);
      flex: 0 0 auto;
    }
    .clear-btn {
      appearance: none;
      border: 1px solid var(--border);
      background: #fff;
      color: var(--muted);
      padding: 10px 14px;
      border-radius: 10px;
      cursor: pointer;
      transition: all .15s ease;
    }
    .clear-btn:hover {
      color: var(--text);
      border-color: #cdd3da;
      transform: translateY(-1px);
    }

    .meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 10px;
      color: var(--muted);
      font-size: 14px;
      gap: 10px;
    }
    .sort-wrap {
      display: flex; align-items: center; gap: 8px;
    }
    .sort-select {
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 8px 10px;
      background: #fff;
      color: var(--text);
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 16px;
      margin-top: 16px;
    }

    .card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: clip;
      display: flex;
      flex-direction: column;
      transition: transform .18s ease, box-shadow .18s ease;
    }
    .card:hover {
      transform: translateY(-3px);
      box-shadow: 0 16px 30px rgba(2, 8, 23, 0.09);
    }

    .media {
      width: 100%;
      aspect-ratio: 4 / 3;
      background: #eef2f7;
      overflow: hidden;
    }
    .media img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .content {
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding: 14px;
    }

    .name {
      font-weight: 700;
      font-size: 16px;
      line-height: 1.25;
    }

    .code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      color: #0b6bcd;
      background: #eaf3ff;
      border: 1px solid #d2e6ff;
      padding: 2px 8px;
      width: fit-content;
      border-radius: 999px;
      font-size: 12px;
    }

    .models {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }
    .model-tag {
      font-size: 12px;
      color: #475569;
      background: #f1f5f9;
      border: 1px solid #e2e8f0;
      border-radius: 999px;
      padding: 2px 8px;
      width: fit-content;
    }

    .desc {
      color: #334155;
      font-size: 14px;
      line-height: 1.4;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
      min-height: 3.6em;
    }

    .price-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: auto;
      padding-top: 6px;
    }
    .price {
      font-weight: 800;
      color: #111827;
      font-size: 18px;
      letter-spacing: -0.01em;
    }
    .cta {
      appearance: none;
      border: 1px solid #dbe3ef;
      background: linear-gradient(180deg, #ffffff, #f7f9fc);
      color: #0b67c0;
      padding: 8px 12px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      transition: all .15s ease;
    }
    .cta:hover { border-color: #cdd6e4; transform: translateY(-1px); }

    .empty {
      display: none;
      text-align: center;
      padding: 36px 12px 48px;
      color: var(--muted);
    }
    .empty.active { display: block; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="title">Parts Catalog</div>
      <div class="subtitle">Browse parts below. Use the search to filter by name, code, description, model, or keywords.</div>
    </header>

    <div class="toolbar">
      <div class="search-wrap">
        <label class="search" for="search">
          <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M21 21l-4.35-4.35M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15z" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
          </svg>
          <input id="search" type="search" placeholder="Search parts..." autocomplete="off" />
        </label>
        <button class="clear-btn" id="clearBtn" title="Clear search">Clear</button>
      </div>

      <div class="meta">
        <div id="count" aria-live="polite">Showing 0 of 0 parts</div>
        <label class="sort-wrap" for="sort">
          <span>Sort</span>
          <select id="sort" class="sort-select">
            <option value="relevance">Relevance</option>
            <option value="price-asc">Price: Low to High</option>
            <option value="price-desc">Price: High to Low</option>
            <option value="name-asc">Name: A–Z</option>
            <option value="name-desc">Name: Z–A</option>
          </select>
        </label>
      </div>
    </div>

    <div id="grid" class="grid" aria-live="polite"></div>
    <div id="empty" class="empty">No parts found. Try different keywords.</div>
  </div>

  <script>
    // Configuration: set to your CSV location (relative or absolute)
    const CSV_URL = 'parts.csv';
    const currency = 'USD';

    // Formatting + DOM refs
    const fmtPrice = new Intl.NumberFormat('en-US', { style: 'currency', currency });
    const grid = document.getElementById('grid');
    const countEl = document.getElementById('count');
    const emptyEl = document.getElementById('empty');
    const searchInput = document.getElementById('search');
    const clearBtn = document.getElementById('clearBtn');
    const sortSelect = document.getElementById('sort');

    // State
    let PARTS = [];
    const SCORES = new Map(); // query-time relevance scores

    // Helpers
    function debounce(fn, wait = 180) {
      let t;
      return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), wait); };
    }

    // Normalize: lowercase, fold accents, normalize separators
    function norm(s) {
      return String(s || '')
        .toLowerCase()
        .normalize('NFKD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/[_/\\-]+/g, ' ')
        .replace(/\s+/g, ' ')
        .trim();
    }

    function splitList(s) {
      // Split on semicolons primarily; also allow commas
      if (!s) return [];
      return String(s)
        .split(/[;]+|,(?!\s)/g)
        .map(v => v.trim())
        .filter(Boolean);
    }

    // CSV parsing (handles quoted fields and escaped quotes)
    function parseCSV(text) {
      const rows = [];
      let i = 0, field = '', row = [], inQuotes = false;

      function pushField() { row.push(field); field = ''; }
      function pushRow() { rows.push(row); row = []; }

      while (i < text.length) {
        const c = text[i];

        if (inQuotes) {
          if (c === '"') {
            if (text[i + 1] === '"') { field += '"'; i++; } // escaped quote
            else { inQuotes = false; }
          } else {
            field += c;
          }
        } else {
          if (c === '"') {
            inQuotes = true;
          } else if (c === ',') {
            pushField();
          } else if (c === '\n') {
            pushField(); pushRow();
          } else if (c === '\r') {
            // ignore, handle \r\n by letting \n close the row
          } else {
            field += c;
          }
        }
        i++;
      }
      // flush last field/row if needed
      if (field.length > 0 || row.length) { pushField(); pushRow(); }

      // Trim empty trailing rows
      while (rows.length && rows[rows.length - 1].every(v => v === '')) rows.pop();
      if (!rows.length) return [];

      // Map to objects using header row (case-insensitive)
      const header = rows[0].map(h => norm(h).replace(/\s+/g, ''));
      const records = rows.slice(1).map(r => {
        const o = {};
        for (let j = 0; j < header.length; j++) {
          o[header[j]] = r[j] ?? '';
        }
        return o;
      });
      return records;
    }

    function recordsToParts(records) {
      return records.map(rec => {
        const name = rec.name ?? rec['name'] ?? '';
        const code = rec.code ?? rec['code'] ?? '';
        const description = rec.description ?? rec['description'] ?? '';
        const price = parseFloat(rec.price ?? rec['price'] ?? '0') || 0;
        const image = rec.image ?? rec['image'] ?? '';
        const models = splitList(rec.models ?? rec['models']);
        const keywords = splitList(rec.keywords ?? rec['keywords']);

        return { name, code, description, price, image, models, keywords };
      });
    }

    async function loadCSV(url) {
      try {
        const res = await fetch(url, { cache: 'no-store' });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const text = await res.text();
        const records = parseCSV(text);
        return recordsToParts(records);
      } catch (err) {
        console.error('Failed to load CSV:', err);
        return [];
      }
    }

    // Rendering
    function render(list) {
      grid.innerHTML = '';
      if (!list.length) emptyEl.classList.add('active');
      else emptyEl.classList.remove('active');

      list.forEach(p => {
        const card = document.createElement('article');
        card.className = 'card';
        card.setAttribute('data-code', p.code);

        const modelsHTML = (p.models || [])
          .map(m => `<span class="model-tag">${m}</span>`)
          .join('');

        const imgSrc = p.image || `https://placehold.co/600x400?text=${encodeURIComponent(p.name || 'Part')}`;

        card.innerHTML = `
          <div class="media">
            <img src="${imgSrc}" alt="${p.name}" loading="lazy" />
          </div>
          <div class="content">
            <div class="name">${p.name}</div>
            <div class="code">${p.code}</div>
            <div class="models" aria-label="Compatible models">${modelsHTML}</div>
            <div class="desc">${p.description}</div>
            <div class="price-row">
              <div class="price">${fmtPrice.format(p.price)}</div>
              <button class="cta" type="button" aria-label="Details for ${p.name}">Details</button>
            </div>
          </div>
        `;

        // Fallback image if broken
        const img = card.querySelector('img');
        img.addEventListener('error', () => {
          img.src = `https://placehold.co/600x400?text=${encodeURIComponent(p.name || 'Part')}`;
        });

        grid.appendChild(card);
      });

      countEl.textContent = `Showing ${list.length} of ${PARTS.length} parts`;
    }

    // Relevance scoring
    const WEIGHTS = { name: 3, code: 3, models: 2, keywords: 1, description: 1 };

    function filterParts(query) {
      const q = norm(query);
      if (!q) {
        SCORES.clear();
        return PARTS.slice();
      }
      const tokens = q.split(' ');
      SCORES.clear();

      return PARTS.filter(p => {
        const f = {
          name: norm(p.name),
          code: norm(p.code),
          description: norm(p.description),
          models: (p.models || []).map(norm),
          keywords: (p.keywords || []).map(norm)
        };

        let score = 0;
        const pass = tokens.every(t => {
          let hit = false;

          for (const key of ['name', 'code', 'description']) {
            const val = f[key];
            if (val && val.includes(t)) {
              hit = true;
              score += WEIGHTS[key] + ((key === 'name' || key === 'code') && val.startsWith(t) ? 1 : 0);
            }
          }
          for (const key of ['models', 'keywords']) {
            const arr = f[key];
            if (arr?.some(v => v.includes(t))) {
              hit = true;
              score += WEIGHTS[key];
            }
          }
          return hit;
        });

        if (pass) SCORES.set(p.code, score);
        return pass;
      });
    }

    function sortParts(list, mode) {
      const arr = list.slice();
      switch (mode) {
        case 'price-asc':
          return arr.sort((a, b) => a.price - b.price || a.name.localeCompare(b.name));
        case 'price-desc':
          return arr.sort((a, b) => b.price - a.price || a.name.localeCompare(b.name));
        case 'name-asc':
          return arr.sort((a, b) => a.name.localeCompare(b.name));
        case 'name-desc':
          return arr.sort((a, b) => b.name.localeCompare(a.name));
        case 'relevance':
        default:
          return arr.sort((a, b) => {
            const sa = SCORES.get(a.code) || 0;
            const sb = SCORES.get(b.code) || 0;
            return (sb - sa) || (a.price - b.price) || a.name.localeCompare(b.name);
          });
      }
    }

    // URL sync
    function updateUrl(q, s) {
      const params = new URLSearchParams(location.search);
      if (q) params.set('q', q); else params.delete('q');
      if (s && s !== 'relevance') params.set('sort', s); else params.delete('sort');
      const qs = params.toString();
      history.replaceState(null, '', qs ? `${location.pathname}?${qs}` : location.pathname);
    }

    // Central update
    function update() {
      const q = searchInput.value;
      const s = sortSelect.value;
      const filtered = filterParts(q);
      const sorted = sortParts(filtered, s);
      render(sorted);
      updateUrl(q, s);
    }

    const debouncedUpdate = debounce(update, 150);

    // Events
    searchInput.addEventListener('input', debouncedUpdate);
    sortSelect.addEventListener('change', update);

    clearBtn.addEventListener('click', () => {
      searchInput.value = '';
      searchInput.focus();
      update();
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if ((e.metaKey || e.ctrlKey) && e.key.toLowerCase() === 'k') {
        e.preventDefault();
        searchInput.focus();
      }
      if (e.key === 'Escape') {
        if (searchInput.value) {
          searchInput.value = '';
          update();
        }
      }
    });

    // Init: read URL, then load CSV and render
    (async function init() {
      const params = new URLSearchParams(location.search);
      const q = params.get('q') || '';
      const s = params.get('sort') || 'relevance';
      searchInput.value = q;
      sortSelect.value = s;

      PARTS = await loadCSV(CSV_URL);
      update();
    })();
  </script>
</body>
</html>