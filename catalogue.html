<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Sellwood catalogue</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800&display=swap" rel="stylesheet">
    <style>
      :root {
        --bg: #f7f8fa;
        --card-bg: #ffffff;
        --text: #000;
        --muted: #aaa;
        --accent: #dc2626;
        --border: #eee;
        --shadow: 0 10px 20px rgba(2, 8, 23, 0.06);
        --radius: 14px;
        --maxw: 1200px;
        --control-h: 46px;
        /* shared height for search/sort */
      }

      * {
        box-sizing: border-box;
      }

      html,
      body {
        height: 100%;
      }

      html {
        scrollbar-gutter: stable;
      }

      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        color: var(--text);
        background: #fff;
      }

      .container {
        max-width: var(--maxw);
        margin: 0 auto;
        padding: 24px 16px 48px;
      }

      header {
        display: grid;
        gap: 10px;
        margin-bottom: 16px;
      }

      .title {
        font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        font-size: clamp(30px, 4vw, 34px);
        font-weight: 800;
        letter-spacing: -0.02em;
        text-align: center;
      }

      .toolbar {
        position: sticky;
        top: 0;
        z-index: 10;
        padding: 12px 0 20px;

      }

      .toolbar::after {
        content: none;
        display: none;
      }

      .search-wrap {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 10px;
        align-items: center;
      }

      .search {
        display: flex;
        align-items: center;
        gap: 10px;
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 10px 12px;
        box-shadow: var(--shadow);
        min-width: 0;
        min-height: var(--control-h);
        margin-left: 15px;
      }

      .search input {
        width: 100%;
        border: none;
        outline: none;
        background: transparent;
        font-size: 16px;
        color: var(--text);
        flex: 1 1 auto;
        min-width: 0;
      }

      .search input::-webkit-search-cancel-button {
        -webkit-appearance: none;
      }

      .search .icon {
        width: 20px;
        height: 20px;
        color: var(--muted);
        flex: 0 0 auto;
      }

      .clear-x {
        appearance: none;
        border: none;
        background: transparent;
        color: var(--muted);
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: none;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        flex: 0 0 auto;
      }

      .search .icon-search {
        display: inline-block;
      }

      .search .clear-x {
        display: none;
      }

      .search.has-value .icon-search {
        display: none;
      }

      .search.has-value .clear-x {
        display: inline-flex;
      }

      .search .count {
        margin-left: auto;
        color: var(--muted);
        font-size: 12px;
        white-space: nowrap;
        flex: 0 0 auto;
      }

      .sort-select {
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 0 12px;
        height: var(--control-h);
        background: #fff;
        color: var(--muted);
        box-shadow: var(--shadow);
        font-size: 16px;
        margin-right: 15px;
      }

      /* Category filter bar */
      .catbar {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
        margin: 10px 15px 0 15px;
        transition: opacity 0.3s ease-out, max-height 0.3s ease-out, margin-top 0.3s ease-out;
        max-height: 40px;
        opacity: 1;
        overflow: hidden;
      }

      .catbar.hidden {
        max-height: 0;
        opacity: 0;
        margin-top: 0;
      }

      .cat-chip {
        appearance: none;
        border: 1px solid #e2e8f0;
        background: #eee;
        color: #0f172a;
        font-size: 13px;
        line-height: 1;
        border-radius: 999px;
        padding: 6px 10px;
        cursor: pointer;
        user-select: none;
        transition: background .15s ease, color .15s ease, border-color .15s ease, box-shadow .15s ease;
      }

      .cat-chip:hover {
        background: #f1f5f9;
      }

      .cat-chip.active {
        background: #fee2e2;
        /* soft red tint */
        color: #b91c1c;
        border-color: #fecaca;
        box-shadow: 0 2px 6px rgba(220, 38, 38, 0.12);
      }

      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
        gap: 16px;
        margin-top: 16px;
      }

      .card {
        background: var(--card-bg);
        border: 2px solid var(--border);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        overflow: clip;
        display: flex;
        flex-direction: column;
        transition: box-shadow .18s ease;
      }

      .card:hover {
        box-shadow: var(--shadow);
      }

      .media {
        width: 100%;
        aspect-ratio: 4 / 3;
        background: #eee;
        overflow: hidden;
        position: relative;
        user-select: none;
        -webkit-user-select: none;
        -webkit-touch-callout: none;
        -webkit-tap-highlight-color: transparent;
      }

      .carousel {
        display: flex;
        width: 100%;
        height: 100%;
        transition: transform .3s ease;
        will-change: transform;
        cursor: pointer;
        -webkit-tap-highlight-color: transparent;
      }

      .slide {
        width: 100%;
        height: 100%;
        flex: 0 0 100%;
        position: relative;
        -webkit-tap-highlight-color: transparent;
      }

      .slide img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
        pointer-events: none;
      }

      .dots {
        position: absolute;
        left: 50%;
        bottom: 8px;
        transform: translateX(-50%);
        display: inline-flex;
        gap: 6px;
        z-index: 2;
        -webkit-tap-highlight-color: transparent;
      }

      .dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        border: 1px solid rgba(0, 0, 0, 0.18);
        background: rgba(255, 255, 255, 0.9);
        padding: 0;
        line-height: 0;
        cursor: pointer;
        box-shadow: var(--shadow);
        backdrop-filter: blur(2px);
        -webkit-tap-highlight-color: transparent;
      }

      .dot.active {
        border-color: var(--accent);
        background: var(--accent);
        box-shadow: 0 2px 6px rgba(220, 38, 38, 0.25);
      }

      .img-price {
        position: absolute;
        left: 10px;
        bottom: 10px;
        padding: 6px 10px;
        border-radius: 999px;
        background: #dc2626;
        color: #fff;
        font-weight: 400;
        font-size: 12px;
        line-height: 1;
        box-shadow: var(--shadow);
        backdrop-filter: blur(2px);
        z-index: 1;
      }

      .img-ctas {
        position: absolute;
        right: 10px;
        bottom: 10px;
        display: inline-flex;
        gap: 8px;
        z-index: 1;
        -webkit-tap-highlight-color: transparent;
      }

      .img-cta {
        appearance: none;
        padding: 6px 10px;
        border-radius: 5px;
        font-size: 12px;
        font-weight: 600;
        line-height: 1;
        display: inline-flex;
        align-items: center;
        border: none;
        background: rgba(255, 255, 255, 0.88);
        color: #000000;
        text-decoration: none;
        cursor: pointer;
        transition: transform .15s ease, background .15s ease;
        box-shadow: var(--shadow);
        backdrop-filter: blur(2px);
        -webkit-tap-highlight-color: transparent;
      }

      .content {
        display: flex;
        flex-direction: column;
        gap: 8px;
        padding: 14px;
      }

      .title-row {
        display: grid;
        grid-template-columns: 1fr auto;
        align-items: center;
        gap: 8px;
      }

      .title-row .name {
        min-width: 0;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .name {
        font-weight: 700;
        font-size: 16px;
        line-height: 1.25;
      }

      .code {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
        color: #000000;
        background: #eee;
        border: 1px solid #e2e8f0;
        padding: 2px 8px;
        width: fit-content;
        border-radius: 999px;
        font-size: 12px;
        flex: 0 0 auto;
      }

      .models {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-top: 4px;
        margin-bottom: 2px;
      }

      .model-tag {
        font-size: 12px;
        color: #b91c1c;
        background: #fee2e2;
        border: 1px solid #fecaca;
        border-radius: 999px;
        padding: 2px 8px;
        width: fit-content;
      }

      /* Material + Finish pills */
      .attrs {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-top: 4px;
        margin-bottom: 2px;
      }

      .attr-pill {
        font-size: 10px;
        color: #000000;
        background: #eee;
        border: 1px solid #e2e8f0;
        border-radius: 999px;
        padding: 2px 8px;
        width: fit-content;
      }

      .material-pill {
        background: #ddd;
      }

      .finish-pill {
        background: #eee;
      }

      .desc {
        color: #334155;
        font-size: 14px;
        line-height: 1.4;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }

      .empty {
        display: none;
        text-align: center;
        color: var(--muted);
        font-size: 14px;
        margin: 24px 0;
      }

      .empty.active {
        display: block;
      }

      /* Modal */
      .modal {
        position: fixed;
        inset: 0;
        z-index: 1000;
        display: grid;
        place-items: center;
        background: rgba(2, 8, 23, 0.55);
        padding: 12px;
        opacity: 0;
        visibility: hidden;
        transition: opacity .18s ease, visibility .18s ease;
      }

      .modal.open {
        opacity: 1;
        visibility: visible;
      }

      .modal .panel {
        box-sizing: border-box;
        width: min(960px, calc(100vw - 24px));
        height: min(92vh, calc(100vh - 24px));
        background: #fff;
        border: 1px solid var(--border);
        border-radius: 12px;
        box-shadow: var(--shadow);
        overflow: hidden;
        display: grid;
      }

      .modal .panel iframe {
        width: 100%;
        height: 100%;
        border: 0;
        display: block;
      }

      @media (max-width: 640px) {
        .modal {
          padding: 10px;
        }

        .modal .panel {
          width: calc(100vw - 20px);
          height: calc(100vh - 20px);
          border-radius: 10px;
        }

        .catbar {
          overflow-x: auto;
          max-height: 100px;
        }
      }

      body.modal-open {
        overflow: hidden;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <div class="title">Sellwood Catalog</div>
      </header>
      <div class="toolbar">
        <div class="search-wrap">
          <label class="search" for="search" id="searchLabel">
            <button class="clear-x" id="clearX" type="button" aria-label="Clear search" title="Clear search">
              <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" />
              </svg>
            </button>
            <svg class="icon icon-search" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M21 21l-4.35-4.35M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15z" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" />
            </svg>
            <input id="search" type="search" placeholder="Search" autocomplete="off" aria-label="Search parts" />
            <span id="count" class="count" aria-live="polite">0 of 0</span>
          </label>
          <select id="sort" class="sort-select" aria-label="Sort">
            <option value="relevance">Sort</option>
            <option value="name-asc">A–Z</option>
            <option value="name-desc">Z–A</option>
            <option value="price-asc">$ Low</option>
            <option value="price-desc">$ High</option>
          </select>
        </div>
        <!-- Category filter bar -->
        <div id="catBar" class="catbar" role="group" aria-label="Filter by category"></div>
      </div>
      <div id="grid" class="grid" aria-live="polite"></div>
      <div id="empty" class="empty" aria-live="polite"></div>
    </div>
    <!-- PDF Modal (desktop) -->
    <div id="pdfModal" class="modal" aria-hidden="true" role="dialog" aria-modal="true">
      <div class="panel">
        <iframe id="pdfFrame" title="PDF"></iframe>
      </div>
    </div>
    <script>
      // Configuration
      const CSV_URL = 'catalogue.csv';
      const currency = 'NZD';
      const IMAGE_DIR = 'images/parts';
      const IMAGE_DEFAULT_EXTS = ['png', 'jpg'];
      const FILE_DIR = IMAGE_DIR;
      const FILE_DEFAULT_EXT = 'pdf';
      // Custom category ordering (others will follow alphabetically)
      const CATEGORY_PRIORITY = ['Attic Ladder', 'Roof Access', 'Roof Hatch', 'Natural Lighting', 'Fixings'];
      const CAT_PARAM = 'cat';
      // DOM refs
      const grid = document.getElementById('grid');
      const countEl = document.getElementById('count');
      const emptyEl = document.getElementById('empty');
      const searchInput = document.getElementById('search');
      const clearX = document.getElementById('clearX');
      const sortSelect = document.getElementById('sort');
      const searchLabel = document.getElementById('searchLabel');
      const pdfModal = document.getElementById('pdfModal');
      const pdfFrame = document.getElementById('pdfFrame');
      const catBar = document.getElementById('catBar');
      const fmtPrice = new Intl.NumberFormat('en-NZ', {
        style: 'currency',
        currency,
        currencyDisplay: 'narrowSymbol'
      });
      // State
      let PARTS = [];
      const SCORES = new Map();
      let lastFocused = null;
      let selectedCategory = ''; // empty = All
      let ALL_CATEGORIES = [];
      // Helpers
      function debounce(fn, wait = 180) {
        let t;
        return (...a) => {
          clearTimeout(t);
          t = setTimeout(() => fn(...a), wait);
        };
      }

      function norm(s) {
        return String(s || '').toLowerCase().normalize('NFKD').replace(/[\u0300-\u036f]/g, '').replace(/[_/\\-]+/g, ' ').replace(/\s+/g, ' ').trim();
      }

      function splitList(s) {
        if (!s) return [];
        return String(s).split(/[;]+|,(?!\s)/g).map(v => v.trim()).filter(Boolean);
      }

      function splitImages(s) {
        if (!s) return [];
        return String(s).split(';').map(v => v.trim()).filter(Boolean);
      }

      function parseCSV(text) {
        const rows = [];
        let i = 0,
          f = '',
          row = [],
          q = false;

        function pushF() {
          row.push(f);
          f = '';
        }

        function pushR() {
          rows.push(row);
          row = [];
        }
        while (i < text.length) {
          const c = text[i];
          if (q) {
            if (c === '\"') {
              if (text[i + 1] === '\"') {
                f += '\"';
                i++;
              } else {
                q = false;
              }
            } else {
              f += c;
            }
          } else {
            if (c === '\"') q = true;
            else if (c === ',') pushF();
            else if (c === '\n') {
              pushF();
              pushR();
            } else if (c === '\r') {} else f += c;
          }
          i++;
        }
        if (f.length > 0 || row.length) {
          pushF();
          pushR();
        }
        while (rows.length && rows[rows.length - 1].every(v => v === '')) rows.pop();
        if (!rows.length) return [];
        const header = rows[0].map(h => norm(h).replace(/\s+/g, ''));
        return rows.slice(1).map(r => {
          const o = {};
          for (let j = 0; j < header.length; j++) o[header[j]] = r[j] ?? '';
          return o;
        });
      }

      function pick(rec, names) {
        for (const n of names) {
          if (rec[n] != null && String(rec[n]).trim() !== '') return rec[n];
        }
        return '';
      }
      // Link: "Label;URL" | "URL"
      function parseLink(raw) {
        const s = String(raw || '').trim();
        if (!s) return null;
        const idx = s.indexOf(';');
        let label = '',
          url = '';
        if (idx === -1) {
          if (/^https?:\/\//i.test(s)) {
            label = 'Link';
            url = s;
          } else return null;
        } else {
          label = s.slice(0, idx).trim();
          url = s.slice(idx + 1).trim();
          if (!url) return null;
          if (!label) label = 'Link';
        }
        return {
          label,
          url
        };
      }
      // Capture original CSV order
      function recordsToParts(records) {
        return records.map((rec, i) => {
          const name = pick(rec, ['name']);
          const code = pick(rec, ['code']);
          const description = pick(rec, ['description']);
          const price = parseFloat(pick(rec, ['price'])) || 0;
          const imageRaw = pick(rec, ['image']);
          const images = splitImages(imageRaw);
          const image = images[0] || '';
          const models = splitList(pick(rec, ['model', 'models']));
          // NEW: categories (support 'catagory' typo and plural)
          const categories = splitList(pick(rec, ['category', 'categories', 'catagory']));
          // Material + Finish (support 'finiah' typo)
          const material = pick(rec, ['material']);
          const finish = pick(rec, ['finish', 'finiah']);
          const keywords = splitList(pick(rec, ['keywords']));
          const linkRaw = pick(rec, ['link']);
          const link = parseLink(linkRaw);
          const file = pick(rec, ['file', 'pdf', 'datasheet']);
          return {
            name,
            code,
            description,
            price,
            image,
            images,
            models,
            categories,
            material,
            finish,
            keywords,
            link,
            file,
            order: i
          };
        });
      }

      function resolveImage(raw) {
        let v = String(raw || '').trim();
        if (!v) return null;
        if (/^(https?:)?\/\//i.test(v) || /^data:/i.test(v)) return v;
        v = v.replace(/\\/g, '/').replace(/^\/+/, '');
        const hasSlash = v.includes('/');
        const hasExt = /\.[a-z0-9]{2,5}(?:[#?].*)?$/i.test(v);
        if (!hasSlash) {
          if (!hasExt && IMAGE_DEFAULT_EXTS[0]) v += '.' + IMAGE_DEFAULT_EXTS[0];
          v = `${IMAGE_DIR.replace(/\/?$/,'/')}${v}`;
        } else {
          if (!hasExt && IMAGE_DEFAULT_EXTS[0]) v += '.' + IMAGE_DEFAULT_EXTS[0];
        }
        return v;
      }

      function resolveFile(raw) {
        let v = String(raw || '').trim();
        if (!v) return null;
        if (/^(https?:)?\/\//i.test(v) || /^data:/i.test(v)) return v;
        v = v.replace(/\\/g, '/').replace(/^\/+/, '');
        const hasSlash = v.includes('/');
        const hasExt = /\.[a-z0-9]{2,5}(?:[#?].*)?$/i.test(v);
        if (!hasSlash) {
          if (!hasExt && FILE_DEFAULT_EXT) v += '.' + FILE_DEFAULT_EXT;
          v = `${FILE_DIR.replace(/\/?$/,'/')}${v}`;
        } else {
          if (!hasExt && FILE_DEFAULT_EXT) v += '.' + FILE_DEFAULT_EXT;
        }
        return v;
      }

      function render(list) {
        grid.innerHTML = '';
        const q = searchInput.value.trim();
        if (!list.length) {
          let msg = '';
          if (PARTS.length === 0) msg = 'No parts available.';
          else if (q || selectedCategory) {
            const catTxt = selectedCategory ? ` in "${selectedCategory}"` : '';
            const qTxt = q ? ` for "${q}"` : '';
            msg = `No parts found${catTxt}${qTxt}.`;
          }
          emptyEl.textContent = msg;
          if (msg) emptyEl.classList.add('active');
          else emptyEl.classList.remove('active');
        } else emptyEl.classList.remove('active');
        list.forEach(p => {
          const card = document.createElement('article');
          card.className = 'card';
          card.setAttribute('data-code', p.code);
          const hasModels = Array.isArray(p.models) && p.models.length > 0;
          const modelsHTML = hasModels ? p.models.map(m => `
						<span class="model-tag">${m}</span>`).join('') : '';
          // Material/Finish pills
          const hasMaterial = !!(p.material && String(p.material).trim());
          const hasFinish = !!(p.finish && String(p.finish).trim());
          const attrsHTML = (hasMaterial || hasFinish) ? `
						<div class="attrs" aria-label="Material and finish">
                ${hasMaterial ? `
							<span class="attr-pill material-pill" title="Material">${p.material}</span>` : ''}
                ${hasFinish ? `
							<span class="attr-pill finish-pill" title="Finish">${p.finish}</span>` : ''}
               
						</div>` : '';
          const rawImages = (Array.isArray(p.images) && p.images.length) ? p.images : (p.image ? [p.image] : []);
          let resolved = rawImages.map(v => resolveImage(v)).filter(Boolean);
          const placeholder = `https://placehold.jp/48/eee/666/600x400.png?text=${encodeURIComponent(p.name || 'Part')}`;
          if (!resolved.length) resolved = [placeholder];
          const slidesHTML = resolved.map((src, i) => `
						<div class="slide">
							<img src="${src}" alt="${(p.name||'Part')} image ${i+1}" loading="lazy" decoding="async" data-original-src="${src}" data-tried-exts="[]" />
						</div>`).join('');
          const dotsHTML = resolved.length > 1 ? `
						<div class="dots">${resolved.map((_,i)=>`
							<button class="dot ${i===0?'active':''}" type="button" aria-label="Go to image ${i+1}" data-i="${i}"></button>`).join('')}
						</div>` : '';
          const linkCTA = (p.link && p.link.url) ? `
						<a class="img-cta" href="${p.link.url}" target="_blank" rel="noopener" aria-label="${p.link.label} for ${p.name}">${p.link.label}</a>` : '';
          const fileUrl = resolveFile(p.file);
          const fileCTA = fileUrl ? `
						<button class="img-cta pdf-cta" type="button" data-file="${fileUrl}" data-title="${p.name}">File</button>` : '';
          const ctaGroup = (linkCTA || fileCTA) ? `
						<div class="img-ctas">${linkCTA}${fileCTA}</div>` : '';
          card.innerHTML = `
            
						<div class="media" data-index="0">
							<div class="carousel" role="group" aria-label="Images for ${p.name}">
                ${slidesHTML}
              </div>
              ${p.price>0 ? `
							<div class="img-price" title="Price">${fmtPrice.format(p.price)}</div>` : ''}
              ${ctaGroup}
              ${dotsHTML}
            
						</div>
						<div class="content">
							<div class="title-row">
								<div class="name">${p.name}</div>
                ${p.code ? `
								<div class="code">${p.code}</div>` : ''}
              
							</div>
              ${hasModels ? `
							<div class="models" aria-label="Compatible models">${modelsHTML}</div>` : ''}
              ${attrsHTML}
              
							<div class="desc">${p.description}</div>
						</div>
          `;
          card.querySelectorAll('.slide img').forEach(img => {
            const originalSrc = img.dataset.originalSrc;
            const handleImageError = (e, triedExts) => {
              const currentExt = triedExts[triedExts.length - 1] || IMAGE_DEFAULT_EXTS[0];
              const nextExtIndex = IMAGE_DEFAULT_EXTS.indexOf(currentExt) + 1;
              if (nextExtIndex < IMAGE_DEFAULT_EXTS.length) {
                const nextExt = IMAGE_DEFAULT_EXTS[nextExtIndex];
                const baseSrc = originalSrc.replace(/\.(png|jpg)$/i, '');
                const newSrc = baseSrc + '.' + nextExt;
                triedExts.push(nextExt);
                img.dataset.triedExts = JSON.stringify(triedExts);
                img.src = newSrc;
              } else {
                img.src = placeholder;
              }
            };
            img.addEventListener('error', (e) => {
              let triedExts = JSON.parse(img.dataset.triedExts || '[]');
              handleImageError(e, triedExts);
            }, { once: true });
          });
          setupCarousel(card.querySelector('.media'));
          grid.appendChild(card);
        });
        countEl.textContent = `${list.length} of ${PARTS.length}`;
      }
      // Carousel
      function setupCarousel(mediaEl) {
        const track = mediaEl.querySelector('.carousel');
        if (!track) return;
        const slides = track.children;
        const dots = mediaEl.querySelectorAll('.dot');
        const total = slides.length;
        if (total <= 1) return;
        let idx = 0,
          startX = 0,
          startY = 0;

        function go(i) {
          idx = (i + total) % total;
          track.style.transform = `translateX(-${idx*100}%)`;
          dots.forEach((d, j) => d.classList.toggle('active', j === idx));
          mediaEl.dataset.index = idx;
        }
        mediaEl.addEventListener('click', (e) => {
          const dot = e.target.closest('.dot');
          if (dot) {
            e.stopPropagation();
            go(parseInt(dot.dataset.i || '0', 10));
            return;
          }
          if (e.target.closest('.img-cta') || e.target.closest('.dots')) return;
          go(idx + 1);
        });
        mediaEl.addEventListener('touchstart', (e) => {
          const t = e.touches[0];
          startX = t.clientX;
          startY = t.clientY;
        }, {
          passive: true
        });
        mediaEl.addEventListener('touchend', (e) => {
          const t = e.changedTouches[0];
          const dx = t.clientX - startX;
          const dy = t.clientY - startY;
          if (Math.abs(dx) > 30 && Math.abs(dx) > Math.abs(dy)) {
            if (dx < 0) go(idx + 1);
            else go(idx - 1);
          }
        }, {
          passive: true
        });
      }
      // Relevance scoring (include material/finish/categories)
      const WEIGHTS = {
        name: 3,
        code: 3,
        models: 2,
        material: 2,
        finish: 1,
        categories: 2,
        keywords: 1,
        description: 1
      };

      function partMatchesCategory(p, cat) {
        if (!cat) return true;
        const cats = (p.categories || []).map(norm);
        return cats.includes(norm(cat));
      }

      function filterParts(query) {
        const q = norm(query);
        if (!q) {
          SCORES.clear();
          // Still apply category filter even when no search query
          return PARTS.filter(p => partMatchesCategory(p, selectedCategory));
        }
        const tokens = q.split(' ');
        SCORES.clear();
        return PARTS.filter(p => {
          if (!partMatchesCategory(p, selectedCategory)) return false;
          const f = {
            name: norm(p.name),
            code: norm(p.code),
            description: norm(p.description),
            material: norm(p.material),
            finish: norm(p.finish),
            categories: (p.categories || []).map(norm),
            models: (p.models || []).map(norm),
            keywords: (p.keywords || []).map(norm)
          };
          let score = 0;
          const pass = tokens.every(t => {
            let hit = false;
            for (const key of ['name', 'code', 'description', 'material', 'finish']) {
              const val = f[key];
              if (val && val.includes(t)) {
                hit = true;
                score += WEIGHTS[key] + ((key === 'name' || key === 'code') && val.startsWith(t) ? 1 : 0);
              }
            }
            for (const key of ['models', 'keywords', 'categories']) {
              const arr = f[key];
              if (arr?.some(v => v.includes(t))) {
                hit = true;
                score += WEIGHTS[key];
              }
            }
            return hit;
          });
          if (pass) SCORES.set(p.code, score);
          return pass;
        });
      }
      // Sorting: Relevance, CSV, alpha, price
      function sortParts(list, mode) {
        const arr = list.slice();
        switch (mode) {
          case 'csv':
            return arr.sort((a, b) => (a.order ?? 0) - (b.order ?? 0));
          case 'price-asc':
            return arr.sort((a, b) => a.price - b.price || a.name.localeCompare(b.name));
          case 'price-desc':
            return arr.sort((a, b) => b.price - a.price || a.name.localeCompare(b.name));
          case 'name-asc':
            return arr.sort((a, b) => a.name.localeCompare(b.name));
          case 'name-desc':
            return arr.sort((a, b) => b.name.localeCompare(a.name));
          case 'relevance':
          default:
            if (SCORES.size === 0) {
              return arr.sort((a, b) => (a.order ?? 0) - (b.order ?? 0));
            } else {
              return arr.sort((a, b) => {
                const sa = SCORES.get(a.code) || 0,
                  sb = SCORES.get(b.code) || 0;
                return sb - sa || (a.order ?? 0) - (b.order ?? 0);
              });
            }
        }
      }
      // URL sync
      function updateUrl(q, s, cat) {
        const params = new URLSearchParams(location.search);
        if (q) params.set('q', q);
        else params.delete('q');
        if (s && s !== 'relevance') params.set('sort', s);
        else params.delete('sort');
        if (cat) params.set(CAT_PARAM, cat);
        else params.delete(CAT_PARAM);
        const qs = params.toString();
        history.replaceState(null, '', qs ? `${location.pathname}?${qs}` : location.pathname);
      }

      function setClearXVisible() {
        const has = searchInput.value.trim().length > 0;
        if (has) clearX.classList.add('visible');
        else clearX.classList.remove('visible');
        searchLabel.classList.toggle('has-value', has);
      }
      // Category bar build/update
      function buildCategoryBar() {
        // Gather unique categories from PARTS
        const set = new Set();
        PARTS.forEach(p => (p.categories || []).forEach(c => {
          if (c && c.trim()) set.add(c.trim());
        }));
        const allCats = Array.from(set);
        // Order: priority list first (if present), then remaining alpha
        const lowerPriority = CATEGORY_PRIORITY.map(norm);
        const pri = CATEGORY_PRIORITY.filter(c => allCats.some(x => norm(x) === norm(c)));
        const rest = allCats.filter(c => !lowerPriority.includes(norm(c))).sort((a, b) => a.localeCompare(b));
        ALL_CATEGORIES = [...pri, ...rest];
        // Render chips
        catBar.innerHTML = '';
        const allChip = chipEl('All', selectedCategory === '' ? true : false, () => {
          selectedCategory = '';
          update();
          updateCatChipActive();
        });
        catBar.appendChild(allChip);
        ALL_CATEGORIES.forEach(c => {
          const active = norm(c) === norm(selectedCategory);
          const el = chipEl(c, active, () => {
            selectedCategory = (norm(selectedCategory) === norm(c)) ? '' : c;
            update();
            updateCatChipActive();
          });
          catBar.appendChild(el);
        });
      }

      function chipEl(label, active = false, onClick) {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'cat-chip' + (active ? ' active' : '');
        btn.textContent = label;
        btn.setAttribute('aria-pressed', active ? 'true' : 'false');
        btn.addEventListener('click', onClick);
        return btn;
      }

      function updateCatChipActive() {
        // Update chip classes/aria and URL
        const chips = catBar.querySelectorAll('.cat-chip');
        chips.forEach(ch => {
          const isAll = ch.textContent === 'All';
          const isActive = isAll ? selectedCategory === '' : norm(ch.textContent) === norm(selectedCategory);
          ch.classList.toggle('active', isActive);
          ch.setAttribute('aria-pressed', isActive ? 'true' : 'false');
        });
        updateUrl(searchInput.value, sortSelect.value, selectedCategory || '');
      }
      // Fit-to-page helper for PDFs
      function withPdfFit(url) {
        const [base, hash = ''] = url.split('#');
        const params = new URLSearchParams(hash);
        if (!params.has('page')) params.set('page', '1');
        if (!params.has('view')) params.set('view', 'Fit');
        if (!params.has('zoom')) {
          const ua = navigator.userAgent;
          const isChrome = /Chrome\/|Chromium\/|CriOS\//.test(ua) && !/Edg\//.test(ua) && !/OPR\//.test(ua);
          params.set('zoom', isChrome ? 'page-width' : 'page-fit');
        }
        const h = params.toString();
        return base + (h ? '#' + h : '');
      }

      function isMobile() {
        return window.matchMedia('(max-width: 640px)').matches || /Mobi|Android|iPhone|iPad|iPod|Windows Phone/i.test(navigator.userAgent);
      }
      // Central update
      function update() {
        const q = searchInput.value;
        const s = sortSelect.value;
        const filtered = filterParts(q);
        const sorted = sortParts(filtered, s);
        render(sorted);
        updateUrl(q, s, selectedCategory || '');
      }
      const debouncedUpdate = debounce(update, 150);
      // Events
      searchInput.addEventListener('input', () => {
        setClearXVisible();
        debouncedUpdate();
      });
      sortSelect.addEventListener('change', update);
      clearX.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        searchInput.value = '';
        setClearXVisible();
        update();
        searchInput.blur();
      });
      // PDF button: mobile opens same tab (single back swipe), desktop opens modal
      grid.addEventListener('click', (e) => {
        const btn = e.target.closest('.pdf-cta');
        if (!btn) return;
        const url = btn.getAttribute('data-file');
        const finalUrl = withPdfFit(url);
        if (isMobile()) {
          // Open in same tab so only one back swipe is needed
          window.location.assign(finalUrl);
          return;
        }
        openPdfModal(finalUrl);
      });
      // Modal behavior (desktop)
      function openPdfModal(url) {
        lastFocused = document.activeElement;
        pdfFrame.src = url;
        pdfModal.classList.add('open');
        document.body.classList.add('modal-open');
        document.addEventListener('keydown', onModalKeydown);
        pdfModal.addEventListener('click', onModalBackdrop);
      }

      function closePdfModal() {
        pdfModal.classList.remove('open');
        document.body.classList.remove('modal-open');
        pdfFrame.src = 'about:blank';
        document.removeEventListener('keydown', onModalKeydown);
        pdfModal.removeEventListener('click', onModalBackdrop);
        if (lastFocused && typeof lastFocused.focus === 'function') lastFocused.focus();
      }

      function onModalKeydown(e) {
        if (e.key === 'Escape') closePdfModal();
      }

      function onModalBackdrop(e) {
        const panel = pdfModal.querySelector('.panel');
        if (!panel.contains(e.target)) closePdfModal();
      }
      // Keyboard shortcuts
      document.addEventListener('keydown', (e) => {
        if ((e.metaKey || e.ctrlKey) && e.key.toLowerCase() === 'k') {
          e.preventDefault();
          searchInput.focus();
        }
        if (e.key === 'Escape' && !pdfModal.classList.contains('open')) {
          if (searchInput.value) {
            searchInput.value = '';
            setClearXVisible();
            update();
            searchInput.blur();
          }
        }
      });

      // Hide category bar when not at top
      let ticking = false;
      function updateCatbarVisibility() {
        catBar.classList.toggle('hidden', window.scrollY > 0);
        ticking = false;
      }
      window.addEventListener('scroll', () => {
        if (!ticking) {
          requestAnimationFrame(updateCatbarVisibility);
          ticking = true;
        }
      }, { passive: true });
      // Init
      (async function init() {
        const params = new URLSearchParams(location.search);
        const q = params.get('q') || '';
        const s = params.get('sort') || 'relevance';
        const cat = params.get(CAT_PARAM) || '';
        searchInput.value = q;
        sortSelect.value = s;
        setClearXVisible();
        selectedCategory = cat;
        PARTS = await loadCSV(CSV_URL);
        buildCategoryBar();
        update();
      })();
      async function loadCSV(url) {
        try {
          const res = await fetch(url, {
            cache: 'no-store'
          });
          if (!res.ok) throw new Error('HTTP ' + res.status);
          const text = await res.text();
          const records = parseCSV(text);
          return recordsToParts(records);
        } catch (err) {
          console.error('Failed to load CSV:', err);
          return [];
        }
      }
    </script>
  </body>
</html>